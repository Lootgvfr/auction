{% extends 'base.html.twig' %}

{% block title %}
	{% if found %}
		{{ lot.name }}
	{% else %}
		Not Found
	{% endif %}
{% endblock %}

{% block css %}
	<link href="{{ asset('css/lot.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
	{% if found %}
		<div class="text-title">{{ lot.name }}</div>
		<div class="else">
			{% if lot.img %}
			<img class="img" src="{{ lot.img }}">
			{% endif %}
			<div class="buy">
				<form method="post" action="{{ path('lot', {'id':lot.id}) }}">
					<div class="bid">
						<div id="pr" class="text"><b>Current price:</b> {% if not price == 0 %}{{ price }}{% else %}{{ lot.currentPrice }}{% endif %} {{ lot.currency.name }}</div>
						{% if lot.status == 'Open' and is_granted('IS_AUTHENTICATED_FULLY') %}
							<button class="submit" name="Bid" type="submit">Make a bid</button>
							<input class="text-input" name="Bid_value" placeholder="Your bid"/>
						{% endif %}
					</div>
					{% if error %}
						<div class="error">{{ error }}</div>
					{% endif %}
					<div class="buyout">
					{% if lot.status == 'Open'%}
						{% if lot.buyoutPrice %}
							<div id="pr" class="text"><b>Buyout price:</b> {{ lot.buyoutPrice }} {{ lot.currency.name }}</div>
							{% if lot.status == 'Open' and is_granted('IS_AUTHENTICATED_FULLY') %}
								<button id="b" class="submit" name="Buyout" type="submit">Buyout</button>
							{% endif %}
						{% endif %}
					{% endif %}
					</div>
				</form>
				{% if lot.status == 'Unconfirmed' %}
				<div class="right">
					This lot is not yet confirmed<br>Duration: {{ duration }} days
				</div>
				{% endif %}
				{% if lot.status == 'Open' %}
				<div class="right">
					Ends on {{ lot.endDate|date('d.m.Y') }}!
				</div>
				{% endif %}
				{% if lot.status == 'Finished' %}
				<div class="right">
					This lot is already closed<br>It was closed on {{ lot.endDate|date('d.m.Y') }}
				</div>
				{% endif %}
				{% if is_granted('IS_AUTHENTICATED_FULLY') and lot.status == 'Unconfirmed' %}
					{% if app.user.username == author.username or app.user.group == 'Manager' or app.user.group == 'Admin' %}
						<div class="right-block">
							<a href="{{ path('edit-lot', {'id':lot.id}) }}">Edit lot</a><br>
							<a href="{{ path('delete-lot', {'id':lot.id}) }}">Delete lot</a>
							{% if app.user.group == 'Manager' or app.user.group == 'Admin' %}
								<br><a href="{{ path('confirm-lot', {'id':lot.id}) }}">Confirm lot</a>
							{% endif %}
						</div>
					{% endif %}
				{% endif %}
			</div>
		</div>
		<div class="props">
			<div id="desc" class="text"><b>Description:</b> {{ lot.description }}</div>
			<p>
				<div class="sep">
					<i><b>Properties:</b></i>
				</div>
				{% for prop in properties %}
					{% if prop.value %}
					<div class="property">
						<b>{{ prop.name }}:</b> {{ prop.value }}
					</div>
					{% endif %}
				{% endfor %}
			</p>
		</div>
		<div class="active_auctions">
		{% for comment in lot.comments %}
			<div class="row post-comment">
				<div class="col-sm-3">
					<strong><a href="{{ path('profile', {'username': comment.author.username}) }}"> {{ comment.author.username }}</a></strong> 
					{{ comment.date|date('d.m.Y') }}
				</div>
				<div class="col-sm-9">
					{{ comment.text }}
				</div>
			</div>
		{% else %}
			<div class="post-comment">
				<p>No comments here yet.</p>
			</div>
		{% endfor %}
		{% if is_granted('IS_AUTHENTICATED_FULLY') %}
			{{ render(controller('AppBundle:Lot:commentLotForm', { 'id': id })) }}
		{% else %}
		<p>
			<a class="submit" href="{{ path('login') }}">
				Sign in
			</a>
			for leaving a comment
		</p>
		{% endif %}
	</div>
	{% else %}
		Lot not found.
	{% endif %}
{% endblock %}